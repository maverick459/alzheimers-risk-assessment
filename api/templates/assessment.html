
{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-body p-4">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                    <div class="step" id="step3">3</div>
                </div>

                <form id="assessmentForm">
                    <!-- Step 1: Demographics -->
                    <div class="step-content" id="step1Content">
                        <h3 class="mb-4"><i class="fas fa-user me-2"></i>Demographics</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="age" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="age" name="age" min="60" max="90" required>
                                <div class="form-text">Age range: 60-90 years</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">Gender *</label>
                                <select class="form-control" id="gender" name="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ethnicity" class="form-label">Ethnicity *</label>
                                <select class="form-control" id="ethnicity" name="ethnicity" required>
                                    <option value="">Select Ethnicity</option>
                                    <option value="caucasian">Caucasian</option>
                                    <option value="african_american">African American</option>
                                    <option value="asian">Asian</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="education" class="form-label">Education Level *</label>
                                <select class="form-control" id="education" name="education" required>
                                    <option value="">Select Education Level</option>
                                    <option value="none">No formal education</option>
                                    <option value="high_school">High School</option>
                                    <option value="bachelors">Bachelor's Degree</option>
                                    <option value="higher">Graduate Degree or Higher</option>
                                </select>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                Next <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Lifestyle Factors -->
                    <div class="step-content d-none" id="step2Content">
                        <h3 class="mb-4"><i class="fas fa-heart me-2"></i>Lifestyle Factors</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="bmi" class="form-label">BMI *</label>
                                <input type="number" class="form-control" id="bmi" name="bmi" min="15" max="40" step="0.1" required>
                                <div class="form-text">Range: 15-40</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="smoking" class="form-label">Do you smoke? *</label>
                                <select class="form-control" id="smoking" name="smoking" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="alcohol" class="form-label">Weekly Alcohol Consumption (units) *</label>
                                <input type="number" class="form-control" id="alcohol" name="alcohol" min="0" max="20" required>
                                <div class="form-text">Range: 0-20 units per week</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="physical_activity" class="form-label">Weekly Physical Activity (hours) *</label>
                                <input type="number" class="form-control" id="physical_activity" name="physical_activity" min="0" max="10" required>
                                <div class="form-text">Range: 0-10 hours per week</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="diet" class="form-label">Diet Quality Score *</label>
                                <input type="number" class="form-control" id="diet" name="diet" min="0" max="10" required>
                                <div class="form-text">0 = Poor, 10 = Excellent</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sleep" class="form-label">Sleep Quality Score *</label>
                                <input type="number" class="form-control" id="sleep" name="sleep" min="4" max="10" required>
                                <div class="form-text">4 = Very Poor, 10 = Excellent</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                Next <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Medical History -->
                    <div class="step-content d-none" id="step3Content">
                        <h3 class="mb-4"><i class="fas fa-notes-medical me-2"></i>Medical History</h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="family_history" class="form-label">Family History of Alzheimer's *</label>
                                <select class="form-control" id="family_history" name="family_history" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cardiovascular" class="form-label">Cardiovascular Disease *</label>
                                <select class="form-control" id="cardiovascular" name="cardiovascular" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="diabetes" class="form-label">Diabetes *</label>
                                <select class="form-control" id="diabetes" name="diabetes" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="depression" class="form-label">Depression *</label>
                                <select class="form-control" id="depression" name="depression" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="head_injury" class="form-label">History of Head Injury *</label>
                                <select class="form-control" id="head_injury" name="head_injury" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="hypertension" class="form-label">Hypertension *</label>
                                <select class="form-control" id="hypertension" name="hypertension" required>
                                    <option value="">Select</option>
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-success" onclick="calculateRisk()">
                                <i class="fas fa-calculator me-2"></i>Calculate Risk
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Calculating your risk assessment...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;

function nextStep(step) {
    if (validateCurrentStep()) {
        saveCurrentStep();
        showStep(step);
    }
}

function prevStep(step) {
    saveCurrentStep();
    showStep(step);
}

function showStep(step) {
    // Hide all step contents
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.add('d-none');
    });
    
    // Show current step content
    document.getElementById(`step${step}Content`).classList.remove('d-none');
    
    // Update step indicators
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 === step) {
            stepEl.classList.add('active');
        } else if (index + 1 < step) {
            stepEl.classList.add('completed');
        }
    });
    
    currentStep = step;
}

function validateCurrentStep() {
    const currentStepContent = document.getElementById(`step${currentStep}Content`);
    const requiredFields = currentStepContent.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            field.classList.add('is-invalid');
            return false;
        } else {
            field.classList.remove('is-invalid');
        }
    }
    return true;
}

function saveCurrentStep() {
    const formData = new FormData(document.getElementById('assessmentForm'));
    const data = Object.fromEntries(formData);
    
    fetch('/save_step', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });
}

async function calculateRisk() {
    if (!validateCurrentStep()) {
        return;
    }
    
    const formData = new FormData(document.getElementById('assessmentForm'));
    const data = Object.fromEntries(formData);
    
    document.getElementById('assessmentForm').classList.add('d-none');
    document.getElementById('loadingIndicator').classList.remove('d-none');
    
    try {
        const response = await fetch('/calculate_risk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.href = '/results';
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
            document.getElementById('assessmentForm').classList.remove('d-none');
            document.getElementById('loadingIndicator').classList.add('d-none');
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
        document.getElementById('assessmentForm').classList.remove('d-none');
        document.getElementById('loadingIndicator').classList.add('d-none');
    }
}

// Load saved data on page load
window.addEventListener('load', function() {
    const savedData = {{ data | tojson | safe }};
    if (savedData) {
        Object.entries(savedData).forEach(([key, value]) => {
            const field = document.getElementById(key);
            if (field) {
                field.value = value;
            }
        });
    }
});
</script>
{% endblock %}
